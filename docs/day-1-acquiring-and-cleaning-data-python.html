<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>DAY 1: Acquiring and cleaning data (Python) | DataFest2021 Project Example</title>
  <meta name="description" content="An example project using COVID-19 data" />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="DAY 1: Acquiring and cleaning data (Python) | DataFest2021 Project Example" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="An example project using COVID-19 data" />
  <meta name="github-repo" content="IQSS/datafest-project" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="DAY 1: Acquiring and cleaning data (Python) | DataFest2021 Project Example" />
  
  <meta name="twitter:description" content="An example project using COVID-19 data" />
  

<meta name="author" content="" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="python-setup.html"/>
<link rel="next" href="optional-u-s-census-data-python.html"/>
<script src="libs/jquery/jquery.min.js"></script>
<link href="libs/gitbook/css/style.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets/htmlwidgets.js"></script>
<link href="libs/leaflet/leaflet.css" rel="stylesheet" />
<script src="libs/leaflet/leaflet.js"></script>
<link href="libs/leafletfix/leafletfix.css" rel="stylesheet" />
<script src="libs/Proj4Leaflet/proj4-compressed.js"></script>
<script src="libs/Proj4Leaflet/proj4leaflet.js"></script>
<link href="libs/rstudio_leaflet/rstudio_leaflet.css" rel="stylesheet" />
<script src="libs/leaflet-binding/leaflet.js"></script>
<script src="libs/leaflet-providers/leaflet-providers_1.9.0.js"></script>
<script src="libs/leaflet-providers-plugin/leaflet-providers-plugin.js"></script>
<link href="libs/HomeButton/home-button.css" rel="stylesheet" />
<script src="libs/HomeButton/home-button.js"></script>
<script src="libs/HomeButton/easy-button-src.min.js"></script>
<script src="libs/clipboard/setClipboardText.js"></script>
<link href="libs/mapviewCSS/mapview-popup.css" rel="stylesheet" />
<link href="libs/mapviewCSS/mapview.css" rel="stylesheet" />


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  { background-color: #f8f8f8; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ef2929; } /* Alert */
code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #c4a000; } /* Attribute */
code span.bn { color: #0000cf; } /* BaseN */
code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4e9a06; } /* Char */
code span.cn { color: #000000; } /* Constant */
code span.co { color: #8f5902; font-style: italic; } /* Comment */
code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code span.dt { color: #204a87; } /* DataType */
code span.dv { color: #0000cf; } /* DecVal */
code span.er { color: #a40000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #0000cf; } /* Float */
code span.fu { color: #000000; } /* Function */
code span.im { } /* Import */
code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code span.ot { color: #8f5902; } /* Other */
code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code span.sc { color: #000000; } /* SpecialChar */
code span.ss { color: #4e9a06; } /* SpecialString */
code span.st { color: #4e9a06; } /* String */
code span.va { color: #000000; } /* Variable */
code span.vs { color: #4e9a06; } /* VerbatimString */
code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">DataFest2021 Example Project</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>What is this?</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#project-summary"><i class="fa fa-check"></i>Project summary</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#authors"><i class="fa fa-check"></i>Authors</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="project-overview.html"><a href="project-overview.html"><i class="fa fa-check"></i>Project overview</a></li>
<li class="part"><span><b>I R</b></span></li>
<li class="chapter" data-level="" data-path="r-setup.html"><a href="r-setup.html"><i class="fa fa-check"></i>R setup</a></li>
<li class="chapter" data-level="" data-path="day-1-acquiring-and-cleaning-data-r.html"><a href="day-1-acquiring-and-cleaning-data-r.html"><i class="fa fa-check"></i>DAY 1: Acquiring and cleaning data (R)</a><ul>
<li class="chapter" data-level="" data-path="day-1-acquiring-and-cleaning-data-r.html"><a href="day-1-acquiring-and-cleaning-data-r.html#acquiring-data-from-apis"><i class="fa fa-check"></i>Acquiring data from APIs</a></li>
<li class="chapter" data-level="" data-path="day-1-acquiring-and-cleaning-data-r.html"><a href="day-1-acquiring-and-cleaning-data-r.html#cleaning-data"><i class="fa fa-check"></i>Cleaning data</a><ul>
<li class="chapter" data-level="" data-path="day-1-acquiring-and-cleaning-data-r.html"><a href="day-1-acquiring-and-cleaning-data-r.html#covid-19-cases-data"><i class="fa fa-check"></i>COVID-19 cases data</a></li>
<li class="chapter" data-level="" data-path="day-1-acquiring-and-cleaning-data-r.html"><a href="day-1-acquiring-and-cleaning-data-r.html#aggregate-data"><i class="fa fa-check"></i>Aggregate data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="optional-u-s-census-data-r.html"><a href="optional-u-s-census-data-r.html"><i class="fa fa-check"></i>OPTIONAL: U.S. Census data (R)</a><ul>
<li class="chapter" data-level="" data-path="optional-u-s-census-data-r.html"><a href="optional-u-s-census-data-r.html#u.s.-census-bureau-api"><i class="fa fa-check"></i>U.S. Census Bureau API</a></li>
<li class="chapter" data-level="" data-path="optional-u-s-census-data-r.html"><a href="optional-u-s-census-data-r.html#clean-u.s.-census-data"><i class="fa fa-check"></i>Clean U.S. Census data</a></li>
<li class="chapter" data-level="" data-path="optional-u-s-census-data-r.html"><a href="optional-u-s-census-data-r.html#combine-census-and-covid-19-data"><i class="fa fa-check"></i>Combine Census and COVID-19 data</a></li>
<li class="chapter" data-level="" data-path="optional-u-s-census-data-r.html"><a href="optional-u-s-census-data-r.html#aggregate-to-weekly-level"><i class="fa fa-check"></i>Aggregate to weekly-level</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="day-2-data-visualization-r.html"><a href="day-2-data-visualization-r.html"><i class="fa fa-check"></i>DAY 2: Data visualization (R)</a><ul>
<li class="chapter" data-level="" data-path="day-2-data-visualization-r.html"><a href="day-2-data-visualization-r.html#non-spatial-graphs"><i class="fa fa-check"></i>Non-spatial graphs</a></li>
<li class="chapter" data-level="" data-path="day-2-data-visualization-r.html"><a href="day-2-data-visualization-r.html#static-maps"><i class="fa fa-check"></i>Static Maps</a></li>
<li class="chapter" data-level="" data-path="day-2-data-visualization-r.html"><a href="day-2-data-visualization-r.html#interactive-maps"><i class="fa fa-check"></i>Interactive Maps</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="day-3-data-analysis-r.html"><a href="day-3-data-analysis-r.html"><i class="fa fa-check"></i>DAY 3: Data analysis (R)</a><ul>
<li class="chapter" data-level="" data-path="day-3-data-analysis-r.html"><a href="day-3-data-analysis-r.html#descriptives"><i class="fa fa-check"></i>Descriptives</a></li>
<li class="chapter" data-level="" data-path="day-3-data-analysis-r.html"><a href="day-3-data-analysis-r.html#modeling"><i class="fa fa-check"></i>Modeling</a><ul>
<li class="chapter" data-level="" data-path="day-3-data-analysis-r.html"><a href="day-3-data-analysis-r.html#cross-sectional-models"><i class="fa fa-check"></i>Cross-sectional models</a></li>
<li class="chapter" data-level="" data-path="day-3-data-analysis-r.html"><a href="day-3-data-analysis-r.html#panel-models"><i class="fa fa-check"></i>Panel models</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="day-4-data-archiving-r.html"><a href="day-4-data-archiving-r.html"><i class="fa fa-check"></i>DAY 4: Data archiving (R)</a></li>
<li class="part"><span><b>II Python</b></span></li>
<li class="chapter" data-level="" data-path="python-setup.html"><a href="python-setup.html"><i class="fa fa-check"></i>Python setup</a></li>
<li class="chapter" data-level="" data-path="day-1-acquiring-and-cleaning-data-python.html"><a href="day-1-acquiring-and-cleaning-data-python.html"><i class="fa fa-check"></i>DAY 1: Acquiring and cleaning data (Python)</a><ul>
<li class="chapter" data-level="" data-path="day-1-acquiring-and-cleaning-data-r.html"><a href="day-1-acquiring-and-cleaning-data-r.html#acquiring-data-from-apis"><i class="fa fa-check"></i>Acquiring data from APIs</a></li>
<li class="chapter" data-level="" data-path="day-1-acquiring-and-cleaning-data-r.html"><a href="day-1-acquiring-and-cleaning-data-r.html#cleaning-data"><i class="fa fa-check"></i>Cleaning data</a><ul>
<li class="chapter" data-level="" data-path="day-1-acquiring-and-cleaning-data-r.html"><a href="day-1-acquiring-and-cleaning-data-r.html#covid-19-cases-data"><i class="fa fa-check"></i>COVID-19 cases data</a></li>
<li class="chapter" data-level="" data-path="day-1-acquiring-and-cleaning-data-r.html"><a href="day-1-acquiring-and-cleaning-data-r.html#aggregate-data"><i class="fa fa-check"></i>Aggregate data</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="optional-u-s-census-data-python.html"><a href="optional-u-s-census-data-python.html"><i class="fa fa-check"></i>OPTIONAL: U.S. Census data (Python)</a><ul>
<li class="chapter" data-level="" data-path="optional-u-s-census-data-r.html"><a href="optional-u-s-census-data-r.html#u.s.-census-bureau-api"><i class="fa fa-check"></i>U.S. Census Bureau API</a></li>
<li class="chapter" data-level="" data-path="optional-u-s-census-data-r.html"><a href="optional-u-s-census-data-r.html#clean-u.s.-census-data"><i class="fa fa-check"></i>Clean U.S. Census data</a></li>
<li class="chapter" data-level="" data-path="optional-u-s-census-data-r.html"><a href="optional-u-s-census-data-r.html#combine-census-and-covid-19-data"><i class="fa fa-check"></i>Combine Census and COVID-19 data</a></li>
<li class="chapter" data-level="" data-path="optional-u-s-census-data-r.html"><a href="optional-u-s-census-data-r.html#aggregate-to-weekly-level"><i class="fa fa-check"></i>Aggregate to weekly-level</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="day-2-data-visualization-python.html"><a href="day-2-data-visualization-python.html"><i class="fa fa-check"></i>DAY 2: Data visualization (Python)</a><ul>
<li class="chapter" data-level="" data-path="day-2-data-visualization-r.html"><a href="day-2-data-visualization-r.html#non-spatial-graphs"><i class="fa fa-check"></i>Non-spatial graphs</a></li>
<li class="chapter" data-level="" data-path="day-2-data-visualization-r.html"><a href="day-2-data-visualization-r.html#static-maps"><i class="fa fa-check"></i>Static Maps</a></li>
<li class="chapter" data-level="" data-path="day-2-data-visualization-r.html"><a href="day-2-data-visualization-r.html#interactive-maps"><i class="fa fa-check"></i>Interactive Maps</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="day-3-data-analysis-python.html"><a href="day-3-data-analysis-python.html"><i class="fa fa-check"></i>DAY 3: Data analysis (Python)</a><ul>
<li class="chapter" data-level="" data-path="day-3-data-analysis-r.html"><a href="day-3-data-analysis-r.html#descriptives"><i class="fa fa-check"></i>Descriptives</a></li>
<li class="chapter" data-level="" data-path="day-3-data-analysis-r.html"><a href="day-3-data-analysis-r.html#modeling"><i class="fa fa-check"></i>Modeling</a><ul>
<li class="chapter" data-level="" data-path="day-3-data-analysis-r.html"><a href="day-3-data-analysis-r.html#cross-sectional-models"><i class="fa fa-check"></i>Cross-sectional models</a></li>
<li class="chapter" data-level="" data-path="day-3-data-analysis-r.html"><a href="day-3-data-analysis-r.html#panel-models"><i class="fa fa-check"></i>Panel models</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="" data-path="day-4-data-archiving-python.html"><a href="day-4-data-archiving-python.html"><i class="fa fa-check"></i>DAY 4: Data archiving (Python)</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">DataFest2021 Project Example</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="day-1-acquiring-and-cleaning-data-python" class="section level1">
<h1>DAY 1: Acquiring and cleaning data (Python)</h1>
<div id="acquiring-data-from-apis" class="section level2">
<h2>Acquiring data from APIs</h2>
<p>Often, we want to acquire data that is stored online. Online data sources are stored somewhere on a remote <em>server</em> — a remotely located computer that is optimized to process requests for information. Usually, we make requests using a browser, also known as a <em>client</em>, but we can also make requests programmatically. An <em>Application Programming Interface</em> (API) is the part of a remote server that receives requests and sends responses. When we make requests programmatically, the responses an API sends are typically data-based, often in some structured format like JSON or XML.</p>
<p>For the project we’ll pursue during DataFest, we’re going to access data stored on the Harvard Dataverse. A Dataverse is open source software for repositing research data. Once data is stored in a Dataverse, it can be accessed programmatically using the Dataverse API. We will use the R package <code>dataverse</code> as an interface for the Dataverse API.</p>
<p>Here are three COVID-19 datasets from the Harvard Dataverse:</p>
<ol style="list-style-type: decimal">
<li>US data on COVID-19 cases and deaths, daily at state-level or county-level: <a href="https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/HIDLTK" class="uri">https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/HIDLTK</a></li>
<li>US data on COVID-19 cases and deaths, daily at metropolitan-level: <a href="https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/5B8YM8" class="uri">https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/5B8YM8</a></li>
<li>World data on COVID-19 cases and deaths, daily at country-level: <a href="https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/L20LOT" class="uri">https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/L20LOT</a></li>
</ol>
<p>As an example of how to use the Dataverse API, we’re going to extract daily data on COVID-19 cases from the U.S. at the state-level (from dataset #1 above). These data span the period from January 21st 2020 until November 29th 2020 for each U.S. state (and the District of Columbia). If you wish, you may choose to use one of the other datasets for your project.</p>
<p>We can use the <code>pyDataverse</code> module as an interface for the API:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb95-1" data-line-number="1"><span class="co"># get the digital object identifier for the Dataverse dataset</span></a>
<a class="sourceLine" id="cb95-2" data-line-number="2">DOI <span class="op">=</span> <span class="st">&quot;doi:10.7910/DVN/HIDLTK&quot;</span></a>
<a class="sourceLine" id="cb95-3" data-line-number="3"></a>
<a class="sourceLine" id="cb95-4" data-line-number="4"><span class="co"># establish connection</span></a>
<a class="sourceLine" id="cb95-5" data-line-number="5">base_url <span class="op">=</span> <span class="st">&#39;https://dataverse.harvard.edu/&#39;</span></a>
<a class="sourceLine" id="cb95-6" data-line-number="6">api <span class="op">=</span> Api(base_url)</a>
<a class="sourceLine" id="cb95-7" data-line-number="7"><span class="bu">print</span>(api.status)</a>
<a class="sourceLine" id="cb95-8" data-line-number="8"></a>
<a class="sourceLine" id="cb95-9" data-line-number="9"><span class="co"># retrieve the contents of the dataset</span></a></code></pre></div>
<pre><code>## OK</code></pre>
<div class="sourceCode" id="cb97"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb97-1" data-line-number="1">covid <span class="op">=</span> api.get_dataset(DOI)</a></code></pre></div>
<p>The <code>covid</code> object is a list of metadata that includes information on all the files stored within this dataset.</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb98-1" data-line-number="1">covid_files_list <span class="op">=</span> covid.json()[<span class="st">&#39;data&#39;</span>][<span class="st">&#39;latestVersion&#39;</span>][<span class="st">&#39;files&#39;</span>]</a></code></pre></div>
<p>Let’s dig further and display the available files:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb99-1" data-line-number="1"><span class="co"># view available files</span></a>
<a class="sourceLine" id="cb99-2" data-line-number="2"><span class="cf">for</span> fileObject <span class="kw">in</span> covid_files_list:</a>
<a class="sourceLine" id="cb99-3" data-line-number="3">    <span class="bu">print</span>(<span class="st">&quot;File name is </span><span class="sc">{}</span><span class="st">; id is </span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(fileObject[<span class="st">&quot;dataFile&quot;</span>][<span class="st">&quot;filename&quot;</span>], fileObject[<span class="st">&quot;dataFile&quot;</span>][<span class="st">&quot;id&quot;</span>]))</a></code></pre></div>
<pre><code>## File name is COUNTY_MAP.zip; id is 3758784
## File name is INDEX.txt; id is 3758782
## File name is METRO_MAP_2018_ESRI.zip; id is 3842202
## File name is METRO_MAP.zip; id is 3826156
## File name is Metropolitan_statistical_areas_for_US_counties__Sept_2018.xml; id is 3867748
## File name is Metropolitan_statistical_areas_for_US_counties__Sept_2018.zip; id is 3867747
## File name is README.txt; id is 3758780
## File name is STATE_MAP.zip; id is 3758781
## File name is us_county_confirmed_cases.tab; id is 4202274
## File name is us_county_deaths_cases.tab; id is 4202273
## File name is us_state_confirmed_case.tab; id is 4201597
## File name is us_state_deaths_case.tab; id is 4201596</code></pre>
<p>For our example project, we’re going to use the data on cumulative COVID-19 cases at the state-level contained in the <code>us_state_confirmed_case.tab</code> file.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb101-1" data-line-number="1"><span class="co"># get data file for COVID-19 cases</span></a>
<a class="sourceLine" id="cb101-2" data-line-number="2">US_states_cases_file <span class="op">=</span> api.get_datafile(<span class="st">&quot;4201597&quot;</span>)</a></code></pre></div>
<p>To convert the data into a more user friendly data frame, we have to jump through a few hoops:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb102-1" data-line-number="1"><span class="co"># convert</span></a>
<a class="sourceLine" id="cb102-2" data-line-number="2">in_text <span class="op">=</span> US_states_cases_file.content</a>
<a class="sourceLine" id="cb102-3" data-line-number="3">tmp <span class="op">=</span> <span class="st">&quot;data_py/US_states_cases.tab&quot;</span></a>
<a class="sourceLine" id="cb102-4" data-line-number="4"></a>
<a class="sourceLine" id="cb102-5" data-line-number="5">f <span class="op">=</span> <span class="bu">open</span>(tmp, <span class="st">&quot;wb&quot;</span>)</a>
<a class="sourceLine" id="cb102-6" data-line-number="6">f.write(in_text)</a></code></pre></div>
<pre><code>## 91400</code></pre>
<div class="sourceCode" id="cb104"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb104-1" data-line-number="1">f.close()</a>
<a class="sourceLine" id="cb104-2" data-line-number="2"></a>
<a class="sourceLine" id="cb104-3" data-line-number="3">US_states_cases <span class="op">=</span> pd.read_csv(tmp, sep<span class="op">=</span><span class="st">&#39;</span><span class="ch">\t</span><span class="st">&#39;</span>)</a></code></pre></div>
<p>We can now inspect the data:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb105-1" data-line-number="1"><span class="co"># inspect the data</span></a>
<a class="sourceLine" id="cb105-2" data-line-number="2"><span class="bu">print</span>(US_states_cases.head(<span class="dv">10</span>)) <span class="co"># 50 states plus DC by 314 days</span></a></code></pre></div>
<pre><code>##    fips                  NAME  ...  2020-11-28  2020-11-29
## 0     1               Alabama  ...      244993      247229
## 1     2                Alaska  ...       31279       31896
## 2     4               Arizona  ...      322774      325995
## 3     5              Arkansas  ...      155026      156247
## 4     6            California  ...     1206278     1219496
## 5     8              Colorado  ...      226567      230057
## 6     9           Connecticut  ...      112581      112581
## 7    10              Delaware  ...       34670       35251
## 8    11  District of Columbia  ...       21308       21448
## 9    12               Florida  ...      985289      992652
## 
## [10 rows x 326 columns]</code></pre>
</div>
<div id="cleaning-data" class="section level2">
<h2>Cleaning data</h2>
<div id="covid-19-cases-data" class="section level3">
<h3>COVID-19 cases data</h3>
<p>The COVID-19 cases data are in wide format, with individual columns for each day’s case counts. To visualize and analyze the data, it will be much easier to reshape the data so that it is organized in long format, with a single column for case counts and another column indicating the date those counts are associated with.</p>
<p>In addition, it will be useful to derive some time-related variables (e.g., day of year, week of year) from the dates. Finally, we should transform our cumulative case counts into regular counts and create some rate variables by normalizing by population count.</p>
<div class="sourceCode" id="cb107"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb107-1" data-line-number="1"><span class="co"># select columns of interest</span></a>
<a class="sourceLine" id="cb107-2" data-line-number="2">US_states_cases_filtered <span class="op">=</span> US_states_cases.<span class="bu">filter</span>(regex<span class="op">=</span><span class="st">&quot;^</span><span class="ch">\\</span><span class="st">d&quot;</span>, axis<span class="op">=</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb107-3" data-line-number="3">US_states_cases_selected <span class="op">=</span> US_states_cases.loc[:, [<span class="st">&#39;fips&#39;</span>, <span class="st">&#39;NAME&#39;</span>, <span class="st">&#39;POP10&#39;</span>]]</a>
<a class="sourceLine" id="cb107-4" data-line-number="4">US_states_cases_selected <span class="op">=</span> US_states_cases_selected.assign(<span class="op">**</span>US_states_cases_filtered)</a>
<a class="sourceLine" id="cb107-5" data-line-number="5"></a>
<a class="sourceLine" id="cb107-6" data-line-number="6"><span class="co"># rename some columns</span></a>
<a class="sourceLine" id="cb107-7" data-line-number="7">US_states_cases_selected <span class="op">=</span> US_states_cases_selected.rename(columns<span class="op">=</span>{<span class="st">&#39;fips&#39;</span>:<span class="st">&#39;GEOID&#39;</span>, <span class="st">&#39;NAME&#39;</span>:<span class="st">&#39;state&#39;</span>, <span class="st">&#39;POP10&#39;</span>:<span class="st">&#39;pop_count_2010&#39;</span>})</a>
<a class="sourceLine" id="cb107-8" data-line-number="8"></a>
<a class="sourceLine" id="cb107-9" data-line-number="9"><span class="co"># reshape to long format for dates</span></a>
<a class="sourceLine" id="cb107-10" data-line-number="10">US_states_cases_selected <span class="op">=</span> pd.melt(US_states_cases_selected, </a>
<a class="sourceLine" id="cb107-11" data-line-number="11">    id_vars<span class="op">=</span>[<span class="st">&quot;GEOID&quot;</span>, <span class="st">&quot;state&quot;</span>, <span class="st">&quot;pop_count_2010&quot;</span>], </a>
<a class="sourceLine" id="cb107-12" data-line-number="12">    var_name<span class="op">=</span><span class="st">&#39;date&#39;</span>, value_name<span class="op">=</span><span class="st">&quot;cases_cum&quot;</span>)</a>
<a class="sourceLine" id="cb107-13" data-line-number="13">US_states_cases_selected <span class="op">=</span> US_states_cases_selected.sort_values([<span class="st">&#39;GEOID&#39;</span>, <span class="st">&#39;date&#39;</span>]).reset_index(drop<span class="op">=</span><span class="va">True</span>)</a>
<a class="sourceLine" id="cb107-14" data-line-number="14"></a>
<a class="sourceLine" id="cb107-15" data-line-number="15"><span class="co"># create new derived time variables from dates </span></a>
<a class="sourceLine" id="cb107-16" data-line-number="16">US_states_cases_selected[<span class="st">&quot;day_of_year&quot;</span>] <span class="op">=</span> pd.to_datetime(US_states_cases_selected.date).dt.dayofyear</a>
<a class="sourceLine" id="cb107-17" data-line-number="17">US_states_cases_selected[<span class="st">&quot;week_of_year&quot;</span>] <span class="op">=</span> pd.to_datetime(US_states_cases_selected.date).dt.isocalendar().week</a>
<a class="sourceLine" id="cb107-18" data-line-number="18">US_states_cases_selected[<span class="st">&quot;month&quot;</span>] <span class="op">=</span> pd.to_datetime(US_states_cases_selected.date).dt.month</a>
<a class="sourceLine" id="cb107-19" data-line-number="19"></a>
<a class="sourceLine" id="cb107-20" data-line-number="20"><span class="co"># create cases counts</span></a>
<a class="sourceLine" id="cb107-21" data-line-number="21">US_states_cases_selected[<span class="st">&quot;cases_count&quot;</span>] <span class="op">=</span> US_states_cases_selected.groupby(<span class="st">&#39;state&#39;</span>).cases_cum.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x <span class="op">-</span> x.shift(<span class="dv">1</span>)).fillna(<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb107-22" data-line-number="22"></a>
<a class="sourceLine" id="cb107-23" data-line-number="23"><span class="co"># tidy-up negative counts</span></a>
<a class="sourceLine" id="cb107-24" data-line-number="24">US_states_cases_selected[<span class="st">&quot;cases_count_pos&quot;</span>] <span class="op">=</span> np.where(US_states_cases_selected[<span class="st">&quot;cases_count&quot;</span>] <span class="op">&lt;</span> <span class="dv">0</span>, <span class="dv">0</span>, US_states_cases_selected[<span class="st">&quot;cases_count&quot;</span>])</a>
<a class="sourceLine" id="cb107-25" data-line-number="25"></a>
<a class="sourceLine" id="cb107-26" data-line-number="26"><span class="co"># create cases rates</span></a>
<a class="sourceLine" id="cb107-27" data-line-number="27">US_states_cases_selected[<span class="st">&quot;cases_rate_100K&quot;</span>] <span class="op">=</span> (US_states_cases_selected[<span class="st">&quot;cases_count_pos&quot;</span>] <span class="op">/</span> US_states_cases_selected[<span class="st">&quot;pop_count_2010&quot;</span>]) <span class="op">*</span> <span class="fl">1e5</span></a>
<a class="sourceLine" id="cb107-28" data-line-number="28">US_states_cases_selected[<span class="st">&quot;cases_cum_rate_100K&quot;</span>] <span class="op">=</span> (US_states_cases_selected[<span class="st">&quot;cases_cum&quot;</span>] <span class="op">/</span> US_states_cases_selected[<span class="st">&quot;pop_count_2010&quot;</span>]) <span class="op">*</span> <span class="fl">1e5</span></a>
<a class="sourceLine" id="cb107-29" data-line-number="29"></a>
<a class="sourceLine" id="cb107-30" data-line-number="30">US_states_cases_selected.to_csv(<span class="st">&quot;data_py/US_states_cases_selected.csv&quot;</span>) <span class="co"># 16014 observations (50 states + 1 DC * 314 days)</span></a></code></pre></div>
</div>
<div id="aggregate-data" class="section level3">
<h3>Aggregate data</h3>
<p>The cleaned data object <code>US_states_cases_selected</code> has 16,014 observations (50 states + 1 DC * 314 days). For visualization, this should be fine in most cases. When we come to build models for these data, they may take a long time to run. If we’re mainly interested in longer term trends, we can probably get a good approximation by aggregating the data to the weekly level for modeling:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb108-1" data-line-number="1"><span class="co"># aggregate to weekly level (for later modeling)</span></a>
<a class="sourceLine" id="cb108-2" data-line-number="2">aggs_by_col <span class="op">=</span> {<span class="st">&#39;pop_count_2010&#39;</span>: <span class="kw">lambda</span> x: np.mean(x), <span class="st">&#39;cases_cum&#39;</span>: <span class="st">&#39;sum&#39;</span>, <span class="st">&#39;cases_cum_rate_100K&#39;</span>: <span class="st">&#39;sum&#39;</span>, <span class="st">&#39;cases_count_pos&#39;</span>: <span class="st">&#39;sum&#39;</span>, <span class="st">&#39;cases_rate_100K&#39;</span>: <span class="st">&#39;sum&#39;</span>}</a>
<a class="sourceLine" id="cb108-3" data-line-number="3"></a>
<a class="sourceLine" id="cb108-4" data-line-number="4">US_states_cases_week <span class="op">=</span> US_states_cases_selected.groupby([<span class="st">&#39;GEOID&#39;</span>, <span class="st">&#39;state&#39;</span>, <span class="st">&#39;week_of_year&#39;</span>], as_index<span class="op">=</span><span class="va">False</span>).agg(aggs_by_col)</a>
<a class="sourceLine" id="cb108-5" data-line-number="5"><span class="bu">print</span>(US_states_cases_week.head(<span class="dv">20</span>))</a></code></pre></div>
<pre><code>##     GEOID    state  ...  cases_count_pos  cases_rate_100K
## 0       1  Alabama  ...              0.0         0.000000
## 1       1  Alabama  ...              0.0         0.000000
## 2       1  Alabama  ...              0.0         0.000000
## 3       1  Alabama  ...              0.0         0.000000
## 4       1  Alabama  ...              0.0         0.000000
## 5       1  Alabama  ...              0.0         0.000000
## 6       1  Alabama  ...              0.0         0.000000
## 7       1  Alabama  ...             23.0         0.481198
## 8       1  Alabama  ...            134.0         2.803502
## 9       1  Alabama  ...            673.0        14.080276
## 10      1  Alabama  ...           1010.0        21.130874
## 11      1  Alabama  ...           1743.0        36.466449
## 12      1  Alabama  ...           1320.0        27.616588
## 13      1  Alabama  ...           1518.0        31.759076
## 14      1  Alabama  ...           1467.0        30.692072
## 15      1  Alabama  ...           2001.0        41.864237
## 16      1  Alabama  ...           1882.0        39.374560
## 17      1  Alabama  ...           2707.0        56.634927
## 18      1  Alabama  ...           3474.0        72.681838
## 19      1  Alabama  ...           2548.0        53.308384
## 
## [20 rows x 8 columns]</code></pre>
<div class="sourceCode" id="cb110"><pre class="sourceCode python"><code class="sourceCode python"><a class="sourceLine" id="cb110-1" data-line-number="1">US_states_cases_week.to_csv(<span class="st">&quot;data_py/US_states_cases_week.csv&quot;</span>)</a></code></pre></div>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="python-setup.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="optional-u-s-census-data-python.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook/js/app.min.js"></script>
<script src="libs/gitbook/js/lunr.js"></script>
<script src="libs/gitbook/js/clipboard.min.js"></script>
<script src="libs/gitbook/js/plugin-search.js"></script>
<script src="libs/gitbook/js/plugin-sharing.js"></script>
<script src="libs/gitbook/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook/js/plugin-bookdown.js"></script>
<script src="libs/gitbook/js/jquery.highlight.js"></script>
<script src="libs/gitbook/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/IQSS/datafest-project/edit/master/COVID19_project_Python.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["DataFest2021_project.pdf", "DataFest2021_project.epub"],
"toc": {
"collapse": "section",
"scroll_highlight": true
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
